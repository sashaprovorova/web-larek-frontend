# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Описываем все имеющиеся категории продаваемого продукта через ProductCategory

```
type ProductCategory =
  | 'софт-скил'
  | 'хард-скил'
  | 'другое'
  | 'дополнительно'
  | 'кнопка';
```

Описываем полученный из API продукт

```
export interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: ProductCategory;
  price: number | null;
}
```

Описываем возможные два способа оплаты

```
type PaymentMethod = 'cash' | 'card';
```

Описываем форму доставки и информацию о покупателе

```
export interface IOrderForm {
	payment: PaymentMethod;
	address: string;
	email: string;
	phone: string;
}
```

Описываем весь заказ

```
export interface IOrder extends IOrderForm {
	items: string[];
	total: number;
}
```

Описываем ответ об оформлении заказа

```
export interface IOrderStatus {
	id: string;
	total: number;
}
```

Описываем ошибки валидации

```
type FormErrors = Partial<Record<keyof IOrderForm, string>>;
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP:

- слой представления, отвечает за отображение данных на странице,
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:

- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.
- Используется как базовый класс для ILarekAPI с методами:
  - getProductList() - получает список товаров
  - getProductItem() - получает один товар по айди
  - orderProducts() - оформляет заказ и получает его статус

Описываем возможные типы запросов на сервер и ответы на них

```
export type ApiListResponse<Type> = {
	total: number;
	items: Type[];
};

export type ApiPostMethods = 'POST' | 'PUT' | 'DELETE';
```

Описываем методы для API

```
export interface ILarekAPI {
	getProductList: () => Promise<IProduct[]>;
	getProductItem: (id: string) => Promise<IProduct>;
	orderProducts: (order: IOrder) => Promise<IOrderStatus>;
}
```

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.

Описываем событийную систему

```
export interface IEvents {
	on<T extends object>(event: EventName, callback: (data: T) => void): void;
	emit<T extends object>(event: string, data?: T): void;
	trigger<T extends object>(
		event: string,
		context?: Partial<T>
	): (data: T) => void;
}
```

Основные методы, реализуемые классом описаны интерфейсом `IEvents`:

- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие
- `onAll` - подписка на все события
- `off` - удаляет конкретного подписчика события
- `offAll` - удаляет все подписки

Используемые типы

```
export type EventName = string | RegExp;
export type Subscriber = Function;
export type EmitterEvent = {
	eventName: string;
	data: unknown;
};
```

### Слой данных

#### Класс ProductData

Класс отвечает за хранение и просмотр списка товаров, полученных с сервера, а также за хранение айди товара, выбранного для предпросмотра.

Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:

- \_products: IProduct[] - массив всех продаваемых товаров
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- setProducts(items: IProduct): void - сохраняет массив товаров и генерирует событие products: changed
- getProduct(id: string): IProduct -возвращает товар по его айди

#### Класс OrderFormData

Класс отвечает за хранение всех данных формы заказа: способа оплаты, адреса, почты и телефона.

Конструктор класса принимает инстанс брокера событий.

В полях класса хранятся следующие данные:

- payment: string - способ оплаты
- address: string - введенный пользователем адрес
- email: string - почта покупателя
- phone: string - введенный пользователем адрес
- touchedFields - отмечает измененные поля

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- setField(field: keyof IOrderForm, value: string) - сохраняет значение поля формы
- getFormData(): IOrder - возвращает текущие данные
- validateDelivery(): boolean - проверяет объект с данными на валидность и генерирует событие order:valid
- validateContacts():boolean - проверяет поля второй формы
- getContactsValidationErrors():Partial<IContactForm> - возвращает объект с ошибками валидации
- getDeliveryData():Pick<IOrderForm, 'address' | 'payment'> - возвращает инфо с первой формы
- clear() - сбрасывает значения

#### Класс BasketData

Класс отвечает за хранение данных корзины и расчет итоговой суммы заказа.

Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:

- items: IProduct[] - текущие товары к корзине
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- getItems(): IProduct[]- возвращает массив товаров в корзине
- getTotal(): number - возвращает общую стоимость товаров в корзине
- add(id: IProduct): void - добавляет товар в корзину и генерирует событие basket: updated
- remove(id: IProduct): void - удаляет товар по айди и генерирует событие basket: updated
- clear(): void - очищает корзину и генерирует событие basket: cleared

### Классы представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс Modal

Реализует уникальное модальное окно, предназначенное для отображения любого содержимого: формы, корзины, карточки товара или успешного заказа. Содержимое передается в форме дом-элемента. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.

- constructor(container: HTMLElement, events: IEvents) Конструктор принимает контейнер модального окна и экземпляр брокера событий.

Поля класса

- modal: HTMLElement - ДОМ элемент модального окна
- content: HTMLElement - контейнер, внутри которого передается содержимое
- events: IEvents - брокер событий

Методы:

- open(content: HTMLElement): void - открывает модальное окно и вставляет переданное содержимое
- close(): void - закрывает модальное окно и очищает содержимое

#### Класс ProductCard

Отвечает за отображение карточки товара. Класс используется для отображения карточек на главной странице сайта в каталоге, а также в корзине. В конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки (полноразмерная в каталоге или же компактная в корзине). В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.

Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий.

Поля класса

- template: HTMLTemplateElement - шаблон карточки
- events: IEvents - брокер событий

Методы:

- disableButton(): void - делает кнопку неактивной
- render(product: IProduct, selected: boolean): HTMLElement - метод возвращает полностью заполненную карточку с установленными слушателями, параметр selected управляет активностью кнопки
- геттер id возвращает уникальный id карточки

#### Класс CatalogPage

Отвечает за отображение блока с карточками на главной странице. В конструктор принимает контейнер, в котором размещаются карточки.

Поля класса

- container: HTMLElement - контейнер для вставки карточек

Методы:

- render(products: HTMLElement[]):void - принимает масссив карточек и отрисовывает их в контейнере
- clear():void - очищает содержимое контейнера перед отрисовкой

#### Класс ProductDetailsView

Отвечает за отображение подробной информации о товаре в модальном окне. Используется для предпросмотра карточки и добавления его в корзину.

Поля класса:

- element: HTMLElement - корневой элемент с разметкой
- category: HTMLElement - категория товара
- title: HTMLElement - название товара
- description: HTMLElement - описание товара
- image: HTMLImageElement - картинка
- price: HTMLElement - цена
- button: HTMLButtonElement - кнопка купить
- events: IEvents - брокер событий

Методы:

- get element(): HTMLElement - возвращает корневой элемент компонента
- set id(value: string):void - устанавливает айди
- set title(value: string): void- устанавливает название
- set description(value: string): void- устанавливает описание
- set category(value: ProductCategory): void- устанавливает категорию
- set price(value: number|null): void- устанавливает цену
- set button(value: string): void- устанавливает надпись на кнопке
- setButtonHandler(text: string, onClick: ()=>void): void- устанавливает текст и обработчик

#### Класс Basket

Отвечает за отображение содержимого корзины.

Поля класса:

- element: HTMLElement - корневой элемент
- list: HTMLElement - контейнер списка товара
- total: HTMLElement - сумма
- button: HTMLButtonElement - кнопка оформить
- events: IEvents - брокер событий

Методы:

- set list(items: HTMLElement[]): void - отрисовывает список товаров и блокирует кнопку если товаров нет
- set price(value: number): void - отображает итоговую сумму
- disableButton():void - диактивирует кнопку

#### Класс DeliveryForm

Отвечает за отображение первого шага заказа, а именно способ оплаты и адрес доставки.

Поля класса:

- element: HTMLElement - корневой элемент формы
- payment: NodeListOf<HTMLElement> - список радио инпутов
- address: HTMLElement - инпут адреса
- submitButton: HTMLButtonElement - кнопка продолжить
- events: IEvents - брокер событий

Методы:

- render(data)- переопределённый метод, восстанавливает активную кнопку способа оплаты
- clear()- сбрасывает форму и сбрасывает активное состояние кнопок

#### Класс ContactForm

Отвечает за отображение второго шага заказа, а именно номер телефона и адрес почты.

Поля класса:

- element: HTMLElement - корневой элемент формы
- email: HTMLElement - инпут адреса почты
- phone: HTMLElement - инпут номера
- submitButton: HTMLButtonElement - кнопка подтвердить
- events: IEvents - брокер событий

Методы:

- email - сеттер для установки почты
- phone - сеттер для установки номера
- clear() - сбрасывает форму

#### Класс Success

Отвечает за отображение финального экрана успешного заказа. Показывает в модальном окне и содержит подтверждение и сумму заказа.

Поля класса:

- description - отображает сумму
- close: - кнопка закрытия

Методы:

- set total(value: number)
  -onClose

## Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера. Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`. В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

_Список всех событий, которые могут генерироваться в системе:_\
_События изменения данных (генерируются классами моделями данных)_

- `products:changed` - изменение массива карточек
- `basket:changed` - изменение массива карточек в корзине
- `basket:cleared`- корзина очищена
- `order:valid` - первая форма прошла валидацию
- `contacts:valid` - вторая форма прошла валидацию
- `order:validation-error` - ошибки валидации первой формы
- `contacts:validation-error` -ошибки валидации второй формы
- `orderInput:change` - изменение значения поля формы
- `order:confirmed` - все данные формы корректны
- `order:success` - успешное оформление заказа

_События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)_

- `modal:open` - открытие модального окна
- `modal:close` - закрыть текущее модальное окно
- `card:select` - выбрать карточку для предпросмотра
- `basket:add` - добавить в корзину
- `basket:remove` - удалить из корзины
- `basket:open` - открыть окно с корзиной
- `order:open` - открыть форму с доставкой
- `order:submit` - отправить форму с доставкой
- `contacts:submit` - отправить форму с контактами
